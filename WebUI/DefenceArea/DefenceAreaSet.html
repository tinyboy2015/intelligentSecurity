<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title></title>
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!--[if lt IE 9]><link rel="stylesheet" type="text/css" href="../plugins/jquery-ui/jquery.ui.1.10.2.ie.css"/><![endif]-->
    <link href="../assets/css/main.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/plugins.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/responsive.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/icons.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../assets/css/fontawesome/font-awesome.min.css">
    <!--[if IE 7]><link rel="stylesheet" href="assets/css/fontawesome/font-awesome-ie7.min.css"><![endif]--><!--[if IE 8]><link href="assets/css/ie8.css" rel="stylesheet" type="text/css"/><![endif]-->

    <script type="text/javascript" src="../assets/js/libs/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../plugins/jquery-ui/jquery-ui-1.10.2.custom.min.js"></script>
    <!--<script type="text/javascript" src="../bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../assets/js/libs/lodash.compat.min.js"></script>
    <script type="text/javascript" src="../plugins/touchpunch/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="../plugins/event.swipe/jquery.event.move.js"></script>
    <script type="text/javascript" src="../plugins/event.swipe/jquery.event.swipe.js"></script>
    <script type="text/javascript" src="../assets/js/libs/breakpoints.js"></script>
    <script type="text/javascript" src="../plugins/respond/respond.min.js"></script>
    <script type="text/javascript" src="../plugins/cookie/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="../plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script type="text/javascript" src="../plugins/slimscroll/jquery.slimscroll.horizontal.min.js"></script>
    <script type="text/javascript" src="../plugins/sparkline/jquery.sparkline.min.js"></script>
    <script type="text/javascript" src="../plugins/daterangepicker/moment.min.js"></script>
    <script type="text/javascript" src="../plugins/daterangepicker/daterangepicker.js"></script>
    <script type="text/javascript" src="../plugins/blockui/jquery.blockUI.min.js"></script>
    <script type="text/javascript" src="../plugins/uniform/jquery.uniform.min.js"></script>
    <script type="text/javascript" src="../plugins/select2/select2.min.js"></script>
    <script type="text/javascript" src="../plugins/datatables/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="../plugins/datatables/DT_bootstrap.js"></script>
    <script type="text/javascript" src="../assets/js/app.js"></script>
    <script type="text/javascript" src="../assets/js/plugins.js"></script>
    <script type="text/javascript" src="../assets/js/plugins.form-components.js"></script>

    <script type="text/javascript" src="../assets/js/custom.js"></script>-->
    <script src="../script/UrlApi.js"></script>
    <script src="../script/CookieUser.js"></script>

    <script src="../script/DefenceAreaSet.js"></script>

    <!--<script>$(document).ready(function () { App.init(); Plugins.init(); FormComponents.init(); GetDefaultValue(); });</script>-->
    <style type="text/css">
        .ComStyle {
            margin: 10px 5px auto 5px;
            border-radius: 10px;
            text-align: center;
            width: 120px;
            height: 100px;
            line-height: 100px;
            /*background-image:url("../images/sxt.png");
            background-repeat:no-repeat;
            background-position:center;*/
            background: url("../images/sxt.png") center no-repeat;
            background-size: cover;
            color: white;
            font-size: 14px;
            font-weight: bold;
            float: left;
        }

        #_canvas {
            /*background: url("../images/line.png") center top no-repeat;*/
        }

        /*._canvasBG {
         background: url("../images/map.jpg") center top no-repeat;
        }*/
       
        body {
            overflow:hidden;
        }
   
    </style>
</head>


<body>
    <div id="container">

        <div id="myModal" role="dialog" aria-labelledby="myModalLabel" style="display:none; z-index:1040; position:fixed; top:180px; right:0;bottom:0;left:0;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="hidmyModal()"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">设置联动设备</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th style="width:36px;">

                                    </th>
                                    <th>
                                        请选择防区所关联的设备
                                        <input id="hidDeviceNum" type="hidden" value="0" />
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="DeviceList">
                                <tr>
                                    <td class="checkbox-column">
                                        <input type="checkbox" class="uniform" checked="checked"  typeCode="aa">
                                    </td>
                                    <td>
                                       
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" onclick="hidmyModal()"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                        <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal" onclick="SaveItem();"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>保存</button>
                    </div>
                </div>
            </div>
        </div>



        <div id="content" style="margin-left:0px;">
            <div class="container">
                <div class="crumbs">
                    <ul id="breadcrumbs" class="breadcrumb">
                        <li>
                            <i class="icon-home">
                            </i>
                            <a href="#">
                                防区管理
                            </a>
                        </li>
                        <li class="current">
                            <a href="#" title="">
                                防区配置
                            </a>
                        </li>

                    </ul>

                </div>

                <div class="row" style="padding-top:20px;">
                    <div class="col-md-12">
                        <div class="widget box">
                            <div class="widget-header">
                                <h4 onclick="ClearCanvas()"><i class="icon-reorder"></i> 防区配置</h4>
                                <div class="toolbar no-padding">
                                    <div class="btn-group"> <span class="btn btn-xs widget-collapse"><i class="icon-angle-down"></i></span> </div>
                                </div>
                            </div>
                            <div class="widget-content" style="height:730px; ">
                                <div style="margin:0px auto auto 0px; width:1200px; height:700px; float:left;">
                                    <canvas id="_canvas">sorry, your broswer does not support html5!</canvas>
                                </div>

                                <div style=" margin:0px 10px auto auto; width:22%; height:700px;  border:1px solid #ebe7e7;">
                                    <div class="widget-header" style="height:36px;">
                                        <h4><i class="icon-reorder"></i> 编辑防区</h4>
                                    </div>
                                    <div class="widget-content">
                                        <div style=" margin:4px auto; width:94%;  text-align:right; ">
                                            <button class="btn btn-info" onclick="newArea()">
                                                新增防区
                                            </button>
                                            <button class="btn btn-danger" onclick="DelALLArea()">
                                                清空防区
                                            </button>
                                        </div>
                                        <div style=" margin:10px auto; width:94%; ">
                                            <table cellpadding="0" cellspacing="0" style="width:100%;  ">
                                                <tr>
                                                    <td style="line-height:60px; text-align:center;">
                                                        防区编号:
                                                    </td>
                                                    <td>
                                                        <input type="text" name="DA_NO" id="DA_NO" class="form-control" style="width:98%;">
                                                        <input id="Hid_DA_seq" type="hidden" value="" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="line-height:60px; text-align:center;">
                                                        防区名称:
                                                    </td>
                                                    <td>
                                                        <input type="text" name="DA_Name" id="DA_Name" class="form-control" style="width:98%;">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="line-height:60px; text-align:center;">
                                                        报警间隔:
                                                    </td>
                                                    <td>
                                                        <input type="text" name="DA_JG" id="DA_JG" class="form-control" style="width:98%;">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="line-height:60px; text-align:center;">
                                                        备注:
                                                    </td>
                                                    <td>
                                                        <input type="text" name="DA_Remark" id="DA_Remark" class="form-control" style="width:98%;">
                                                    </td>
                                                </tr>

                                            </table>
                                            <table cellpadding="0" cellspacing="0" style="width:100%;  ">
                                                <tr>
                                                    <td style="line-height:60px; text-align:center;">
                                                        <button class="btn btn-block" onclick="insert()">
                                                            联动设备
                                                        </button>
                                                        <input id="hidDeviceID" type="hidden" value="" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="line-height:60px; text-align:right;">
                                                        <button class="btn btn-info" onclick="SaveArea()">
                                                            保存设置
                                                        </button>
                                                        <button class="btn btn-danger" onclick="DelArea(1)">
                                                            删除防区
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin:10px auto; width:100%; height:50px; border:1px solid #ff6a00; display:none;" id="aaa">

                            </div>
                            <div style="margin:10px auto; width:100%; height:50px; border:1px solid #ff6a00; display:none;" id="dqZB">

                            </div>
                            <div style="margin:10px auto; width:100%; height:50px; border:1px solid #ff6a00; display:none;" id="groupZBList">

                            </div>
                            <div style="margin:10px auto; width:100%; height:50px; border:1px solid #ff6a00; display:none;" id="djzb">

                            </div>

                            <div style="margin:10px auto; width:100%; height:50px; border:1px solid #ff6a00; display:none;" id="xswz">

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
   GetDefaultValue();
//控制是否可以画线
var flag = 0;
var canvas_ = document.getElementById("_canvas");

//全屏
canvas_.setAttribute("width", "1200");
canvas_.setAttribute("height", "700");
var context = canvas_.getContext("2d");
var array_paint = [];
var current_y = 0;
var current_x = 0;

    var c_x = 0;
    var c_y=0;
//判断鼠标是否按下
var m_down = false;
//array_paint.push([294, 85][308, 85][335, 84][392, 84][487, 84][582, 84][679, 84][760, 84][812, 84][859, 84][873, 84][877, 83][878, 83]);
//array_paint.push([184, 46]);
//array_paint.push([188, 46]);
//array_paint.push([194, 48]);
//paint();
//array_paint = [];


GetDefenceAreaLines();



function SetCanvas() {
    context.strokeStyle = "blue";
    context.lineWidth = 6;
}


function paint() {
    context.beginPath();
    context.moveTo(array_paint[0][0], array_paint[0][1]);
    if (array_paint.length == 1)
        context.lineTo(array_paint[0][0] + 1, array_paint[0][1] + 1);
    else {
        var i = 1;
        for (i in array_paint) {
            context.lineTo(array_paint[i][0], array_paint[i][1]);
            context.moveTo(array_paint[i][0], array_paint[i][1]);
        }

    }
    context.closePath();
    context.stroke();
}


//按下鼠标
canvas_.onmousedown = function (event) {
    if (flag == 1) {
        SetCanvas();
        m_down = true;
        current_x = event.offsetX;
        current_y = event.offsetY;
        // c_x = current_x;
        //c_y=current_y;
        array_paint.push([current_x, current_y]);
        $("#dqZB").append(current_x + "," + current_y + "_");
        paint();
    }
    else {
        $("#djzb").html("");
        current_x = event.offsetX;
        current_y = event.offsetY;
        //var djzb = current_x + "," + current_y;
        //context.strokeStyle = "red";
        //context.lineWidth = 6;
        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 5; j++) {
                // array_paint.push([current_x+i, current_y + j]);
                $("#djzb").append((current_x + i) + "," + (current_y + j) + "|");
            }

        }

        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 5; j++) {
                //array_paint.push([current_x-i, current_y - j]);
                $("#djzb").append((current_x - i) + "," + (current_y - j) + "|");
            }
        }

        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 5; j++) {
                //array_paint.push([current_x+j, current_y+i]);
                $("#djzb").append((current_x + j) + "," + (current_y + i) + "|");
            }
        }

        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 5; j++) {
                // array_paint.push([current_x-j, current_y-i]);
                $("#djzb").append((current_x - j) + "," + (current_y - i) + "|");
            }
        }

        $("#xswz").html(current_x + "," + current_y);
        // paint();
        GetDefenceAreaLines();

    }

}


//鼠标松开,清空数据
canvas_.onmouseup = function (event) {
    //if (flag == 1) {
        m_down = false;
    //    array_paint = [];
    //    //flag = 0;
    //    //alert("jj");
    //}
     c_x = 0;
     c_y=0;
}


//鼠标按下后拖动
canvas_.onmousemove = function (event) {
    if (flag == 1) {
        if (m_down) {
            current_x = event.offsetX;
            current_y = event.offsetY;

           //var direction = Math.round((((Math.atan2(current_y, current_x) * (180 / Math.PI)) + 180) / 90) + 3) % 4; 
            //if (current_x > c_x) {
            //     array_paint.push([current_x, current_y]);
            //}
           // $("#aaa").append(direction);
            array_paint.push([current_x, current_y]);
            $("#dqZB").append(current_x + "," + current_y + "_");
            paint();
        }
    }
}

function ClearCanvas() {
    //var cxt = document.getElementById("myCanvas").getContext("2d");
    context.clearRect(0, 0, 1200, 700);
    flag = 0;
    ClearText();

}


function newArea() {
    flag = 1;
    ClearText();
}

function ClearText() {
    $("#DA_NO").val("");
    $("#Hid_DA_seq").val("");
    $("#DA_Name").val("");
    $("#DA_JG").val("");
    $("#DA_Remark").val("");
    $("#dqZB").html("");
    $("#hidDeviceID").val("");

    m_down = false;
    array_paint = [];
}

function SaveArea() {
    var DA_NO = $("#DA_NO").val();
    var Hid_DA_seq = $("#Hid_DA_seq").val();
    var DA_Name = $("#DA_Name").val();
    var DA_JG = $("#DA_JG").val();
    var DA_Remark = $("#DA_Remark").val();
    var dqZB = $("#dqZB").html();
    var DAID = $("#hidDeviceID").val();  //防区联动设备
    var param = {
        DA_NO: DA_NO,
        Hid_DA_seq: Hid_DA_seq,
        DA_Name: DA_Name,
        DA_JG: DA_JG,
        DA_Remark: DA_Remark,
        dqZB: dqZB,
        DAID: DAID,
        userkey: "admin",
        userPwd: "admin",
    };
    $.ajaxSettings.async = false;
    $.ajax({
        url: apiurl + "DefenceArea/SetDefenceArea.aspx",
        type: 'post',
        data: param, //参数
        success: function (result) {//成功后执行的方法
            //alert(result); // 后台返回值
            var ja = JSON.parse(result);
            if (ja.message == "2000") {
                var rtnJson = JSON.parse(ja.returnValue);
                flag = 0;
                m_down = false;
                array_paint = [];
                alert(rtnJson.rs);

            }
            else {

                flag = 0;
                alert(result);
            }

        },
        error: function (result) {//失败执行的方法
            alert("error: 数据访问超时，请稍后再试！" + result.responseText);
        }
    });
}

function GetDefenceAreaLines() {
    var djzb = $("#djzb").html();
    var param = {
        djzb: djzb,
        userkey: "admin",
        userPwd: "admin",
    };

    $.ajaxSettings.async = false;
    $.ajax({
        url: apiurl + "DefenceArea/GetDefenceAreaLines.aspx",
        type: 'post',
        data: param, //参数
        success: function (result) {//成功后执行的方法
            //alert(result); // 后台返回值
            var ja = JSON.parse(result);
            if (ja.message == "2000") {
                var parsedJson = JSON.parse(ja.returnValue);
                ShowList(parsedJson);
            }
            else {
                alert(result);
            }
        },
        error: function (result) {//失败执行的方法
            alert("error: 数据访问超时，请稍后再试！" + result.responseText);
        }
    });
}

function ShowList(parsedJson) {
    ClearCanvas();
    //SetCanvas();
    $("#dqZB").html("");
    for (var i = 0; i < parsedJson.length; i++) {
        var state = parsedJson[i].DA_State;
        if (state == "0") {
            SetCanvas();
            var str = parsedJson[i].DA_Area.split('_');
            for (var j = 0; j < str.length; j++) {
                if (str[j] != "") {
                    var zb = str[j].split(',');
                    array_paint.push([zb[0], zb[1]]);
                    $("#groupZBList").append([zb[0], zb[1]] + "_____");
                }
            }
            paint();
            array_paint = [];
        }
        else {
            SetCanvasRed();
            var str = parsedJson[i].DA_Area.split('_');
            for (var j = 0; j < str.length; j++) {
                if (str[j] != "") {
                    var zb = str[j].split(',');
                    array_paint.push([zb[0], zb[1]]);
                    $("#groupZBList").append([zb[0], zb[1]] + "_____");
                }
            }
            paint();
            array_paint = [];

            $("#DA_NO").val(parsedJson[i].DA_NO);
            $("#Hid_DA_seq").val(parsedJson[i].DA_seq);
            $("#DA_Name").val(parsedJson[i].DA_Name);
            $("#DA_JG").val(parsedJson[i].DA_JG);
            $("#DA_Remark").val(parsedJson[i].DA_Remark);
            $("#dqZB").html(parsedJson[i].DA_Area);
            $("#hidDeviceID").val(parsedJson[i].DAID);

            var tszb = $("#xswz").html().split(',');
            context.fillStyle = '#FFFFFF';
            context.font = 'bold 18px 微软雅黑';
            context.fillText(parsedJson[i].DA_Name, tszb[0], tszb[1]);
            //var img = new Image();
            //img.src = "../images/tb1.png";
            //context.drawImage(img, 520, 68);

        }
    }

    //只显示画的线
    //for (var i = 0; i < parsedJson.length; i++) {
    //    var str = parsedJson[i].DA_Area.split('_');
    //    for (var j = 0; j < str.length; j++) {
    //        if (str[j] != "") {
    //            var zb = str[j].split(',');                    
    //            array_paint.push([zb[0],zb[1]]);  

    //            $("#groupZBList").append([zb[0],zb[1]]+"_____");
    //        }               
    //    }
    //    paint();
    //    array_paint = [];
    //}
}

function DelALLArea() {
    ClearCanvas();
    DelArea(0);
}

function SetCanvasRed() {
    context.strokeStyle = "red";
    context.lineWidth = 6;
}

function DelArea(Dstate) {
    var DA_seq = $("#Hid_DA_seq").val();
    var delState = Dstate;
    var param = {
        DA_seq: DA_seq,
        delState: delState,
        userkey: "admin",
        userPwd: "admin",
    };
    $.ajaxSettings.async = false;
    $.ajax({
        url: apiurl + "DefenceArea/SetDefenceAreaDel.aspx",
        type: 'post',
        data: param, //参数
        success: function (result) {//成功后执行的方法
            //alert(result); // 后台返回值
            var ja = JSON.parse(result);
            if (ja.message == "2000") {
                var rtnJson = JSON.parse(ja.returnValue);
                flag = 0;
                GetDefenceAreaLines();
                alert(rtnJson.rs);

            }
            else {
                flag = 0;
                alert(result);
            }

        },
        error: function (result) {//失败执行的方法
            alert("error: 数据访问超时，请稍后再试！" + result.responseText);
        }
    });
}


</script>
